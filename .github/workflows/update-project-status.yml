name: Update Project Status on Push

on:
  push:
    branches:
      - '*-*' # ex) 51-issue-name

jobs:
  update_project_status:
    runs-on: ubuntu-latest
    steps:
      - name: Extract issue number from branch name
        id: extract_issue
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '^[0-9]+')
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Error: No issue number found in branch name."
            exit 1
          fi
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"
          echo "Extracted issue number: $ISSUE_NUMBER"

      - name: Move issue to "진행중" column
        uses: actions/github-script@v6
        with:
          script: |
            const { graphql } = github;

            const issueNumber = process.env.ISSUE_NUMBER;
            const projectName = "umbrella";
            const targetStatus = "진행중";

            try {
              const { owner, repo } = context.repo;

              console.log('owner: ', owner);

              // 📌 프로젝트 ID 자동 조회
              const projectQuery = await graphql(
                `
                query($owner: String!, $projectName: String!) {
                  repository(owner: $owner, name: $projectName) {
                    projectsV2(first: 1) {
                      nodes {
                        id
                      }
                    }
                  }
                }
                `,
                {
                  owner: owner,
                  projectName: repo, // 프로젝트가 저장소 레벨에 있을 경우
                  headers: {
                    authorization: `token ${process.env.GITHUB_TOKEN}`,
                  },
                }
              );

              const projectId = projectQuery.repository.projectsV2.nodes[0]?.id;
              if (!projectId) throw new Error(`Project '${projectName}' not found.`);

              // 📌 이슈 ID 가져오기
              const issueQuery = await graphql(
                `
                query($owner: String!, $repo: String!, $issueNumber: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issueNumber) {
                      id
                    }
                  }
                }
                `,
                {
                  owner: owner,
                  repo: repo,
                  issueNumber: parseInt(issueNumber),
                  headers: {
                    authorization: `token ${process.env.GITHUB_TOKEN}`,
                  },
                }
              );

              const issueId = issueQuery.repository.issue.id;
              if (!issueId) throw new Error(`Issue #${issueNumber} not found.`);

              // 📌 프로젝트 카드 업데이트 API
              const updateResponse = await graphql(
                `
                mutation($projectId: ID!, $issueId: ID!, $status: String!) {
                  updateProjectItem(input: { projectId: $projectId, itemId: $issueId, status: $status }) {
                    item {
                      id
                      status
                    }
                  }
                }
                `,
                {
                  projectId: projectId,
                  issueId: issueId,
                  status: targetStatus,
                  headers: {
                    authorization: `token ${process.env.GITHUB_TOKEN}`,
                  },
                }
              );

              console.log(`Moved issue #${issueNumber} to "${targetStatus}" in project ID: ${projectId}`);
            } catch (error) {
              console.error("Error:", error);
              throw error;
            }
        env:
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
